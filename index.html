<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Play Count Calendar</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    table { border-collapse: collapse; }
    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: center;
      min-width: 36px;
    }
    .name-btn {
      cursor: default;
      background: #f0f0f0;
      border: none;
      padding: 6px 10px;
    }
    .today { background: #ffeeba; }
    .circle { color: red; font-size: 18px; }
    td.clickable { cursor: pointer; }
  </style>
</head>
<body>

<h2>月間カウント</h2>

<button id="prevMonth">←</button>
<span id="ym"></span>
<button id="nextMonth">→</button>

<br><br>

<input id="nameInput" placeholder="名前を追加" />
<button id="addNameBtn">追加</button>

<br><br>

<table id="calendar"></table>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import {
    getFirestore,
    collection,
    addDoc,
    doc,
    onSnapshot,
    updateDoc,
    getDoc
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  /* Firebase */
  const firebaseConfig = {
    apiKey: "AIzaSyCTri3rZLiory39Om1bjXcdVfTow7dXrfE",
    authDomain: "playcount-805bd.firebaseapp.com",
    projectId: "playcount-805bd",
    storageBucket: "playcount-805bd.firebasestorage.app",
    messagingSenderId: "259970586499",
    appId: "1:259970586499:web:6bd8ea72419279e91308b6",
    measurementId: "G-H1BL5VPHEK"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  /* 日付状態（★重要） */
  const now = new Date();
  let currentYear = now.getFullYear();
  let currentMonth = now.getMonth(); // 0始まり

  const table = document.getElementById("calendar");
  const ymSpan = document.getElementById("ym");

  function getDaysInMonth(y, m) {
    return new Date(y, m + 1, 0).getDate();
  }

  function updateYMLabel() {
    ymSpan.textContent = `${currentYear}年 ${currentMonth + 1}月`;
  }

  function renderHeader() {
    const tr = document.createElement("tr");
    tr.innerHTML = `<th>名前</th><th>合計</th>`;

    const days = getDaysInMonth(currentYear, currentMonth);
    for (let d = 1; d <= days; d++) {
      tr.innerHTML += `<th>${d}</th>`;
    }
    table.appendChild(tr);
  }

  function renderName(docSnap) {
    const data = docSnap.data();
    const marks = data.marks || {};
    const tr = document.createElement("tr");

    let count = 0;

    /* 名前 */
    const nameCell = document.createElement("td");
    const btn = document.createElement("button");
    btn.className = "name-btn";
    btn.textContent = data.name;
    nameCell.appendChild(btn);
    tr.appendChild(nameCell);

    /* 合計 */
    const totalCell = document.createElement("td");
    tr.appendChild(totalCell);

    const days = getDaysInMonth(currentYear, currentMonth);
    const todayKey = new Date().toISOString().slice(0, 10);

    for (let d = 1; d <= days; d++) {
      const dateKey =
        `${currentYear}-${String(currentMonth + 1).padStart(2, "0")}-${String(d).padStart(2, "0")}`;

      const td = document.createElement("td");
      td.classList.add("clickable");

      if (marks[dateKey]) {
        td.innerHTML = `<span class="circle">◯</span>`;
        count++;
      }

      if (dateKey === todayKey) {
        td.classList.add("today");
      }

      td.onclick = () => toggleMark(docSnap.id, dateKey);

      tr.appendChild(td);
    }

    totalCell.textContent = count;
    table.appendChild(tr);
  }

  async function toggleMark(id, dateKey) {
    const ref = doc(db, "names", id);
    const snap = await getDoc(ref);
    const marks = snap.data().marks || {};

    if (marks[dateKey]) {
      delete marks[dateKey];
    } else {
      marks[dateKey] = true;
    }

    await updateDoc(ref, { marks });
  }

  function rerender() {
    table.innerHTML = "";
    updateYMLabel();
    renderHeader();
    snapshotCache.forEach(renderName);
  }

  let snapshotCache = [];

  onSnapshot(collection(db, "names"), snap => {
    snapshotCache = [];
    snap.forEach(d => snapshotCache.push(d));
    rerender();
  });

  document.getElementById("addNameBtn").onclick = async () => {
    const input = document.getElementById("nameInput");
    const name = input.value.trim();
    if (!name) return;
    await addDoc(collection(db, "names"), { name, marks: {} });
    input.value = "";
  };

  document.getElementById("prevMonth").onclick = () => {
    currentMonth--;
    if (currentMonth < 0) {
      currentMonth = 11;
      currentYear--;
    }
    rerender();
  };

  document.getElementById("nextMonth").onclick = () => {
    currentMonth++;
    if (currentMonth > 11) {
      currentMonth = 0;
      currentYear++;
    }
    rerender();
  };
</script>

</body>
</html>
