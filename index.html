<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Play Count Calendar</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    table { border-collapse: collapse; }
    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: center;
      min-width: 36px;
    }
    .name-btn {
      cursor: pointer;
      background: #f0f0f0;
      border: none;
      padding: 6px 10px;
    }
    .today { background: #ffeeba; }
    .circle { color: red; font-size: 18px; }
    .delete-btn {
      color: white;
      background: red;
      border: none;
      margin-left: 6px;
      cursor: pointer;
    }
  </style>
</head>
<body>

<h2>月間カウント</h2>

<input id="nameInput" placeholder="名前を追加" />
<button id="addNameBtn">追加</button>

<br><br>

<table id="calendar"></table>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import {
    getFirestore,
    collection,
    addDoc,
    deleteDoc,
    doc,
    onSnapshot,
    updateDoc,
    setDoc,
    getDoc
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCTri3rZLiory39Om1bjXcdVfTow7dXrfE",
    authDomain: "playcount-805bd.firebaseapp.com",
    projectId: "playcount-805bd",
    storageBucket: "playcount-805bd.firebasestorage.app",
    messagingSenderId: "259970586499",
    appId: "1:259970586499:web:6bd8ea72419279e91308b6",
    measurementId: "G-H1BL5VPHEK"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const today = new Date();
  const year = today.getFullYear();
  const month = today.getMonth(); // 0-based
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  const todayKey = today.toISOString().slice(0, 10);

  const table = document.getElementById("calendar");

  function renderHeader() {
    const tr = document.createElement("tr");
    tr.innerHTML = `<th>名前</th>`;
    tr.innerHTML += `<th>合計</th>`;
    for (let d = 1; d <= daysInMonth; d++) {
      const isToday = d === today.getDate();
      tr.innerHTML += `<th class="${isToday ? "today" : ""}">${d}</th>`;
    }
    table.appendChild(tr);
  }

  function renderName(docSnap) {
    const data = docSnap.data();
    const marks = data.marks || {};
    const tr = document.createElement("tr");

    let count = 0;

    const nameCell = document.createElement("td");
    const btn = document.createElement("button");
    btn.className = "name-btn";
    btn.textContent = data.name;
    btn.onclick = () => toggleMark(docSnap.id);

    const del = document.createElement("button");
    del.textContent = "×";
    del.className = "delete-btn";
    del.onclick = () => deleteDoc(doc(db, "names", docSnap.id));

    nameCell.appendChild(btn);
    nameCell.appendChild(del);
    tr.appendChild(nameCell);

    for (let d = 1; d <= daysInMonth; d++) {
      const dateKey = `${year}-${String(month + 1).padStart(2, "0")}-${String(d).padStart(2, "0")}`;
      const td = document.createElement("td");
      if (marks[dateKey]) {
        td.innerHTML = `<span class="circle">◯</span>`;
        count++;
      }
      tr.appendChild(td);
    }

    const total = document.createElement("td");
    total.textContent = count;
    tr.appendChild(total);

    table.appendChild(tr);
  }

  async function toggleMark(id) {
    const ref = doc(db, "names", id);
    const snap = await getDoc(ref);
    const marks = snap.data().marks || {};

    if (marks[todayKey]) {
      delete marks[todayKey];
    } else {
      marks[todayKey] = true;
    }
    await updateDoc(ref, { marks });
  }

  document.getElementById("addNameBtn").onclick = async () => {
    const name = document.getElementById("nameInput").value.trim();
    if (!name) return;
    await addDoc(collection(db, "names"), { name, marks: {} });
    document.getElementById("nameInput").value = "";
  };

  onSnapshot(collection(db, "names"), snap => {
    table.innerHTML = "";
    renderHeader();
    snap.forEach(renderName);
  });
</script>

</body>
</html>

