<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Play Count Calendar</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    table { border-collapse: collapse; }
    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: center;
      min-width: 36px;
    }
    .name-btn {
      cursor: pointer;
      background: #f0f0f0;
      border: none;
      padding: 6px 10px;
    }
    .today { background: #ffeeba; }
    .circle { color: red; font-size: 18px; }

    /* ★ 追加：エイプリルフール強演出 */
    .glitch { /* ★ 追加 */
      animation: shake 0.1s infinite; /* ★ 追加 */
      filter: invert(1) hue-rotate(180deg); /* ★ 追加 */
    } /* ★ 追加 */

    @keyframes shake { /* ★ 追加 */
      0% { transform: translate(2px, -2px); } /* ★ 追加 */
      25% { transform: translate(-2px, 2px); } /* ★ 追加 */
      50% { transform: translate(2px, 2px); } /* ★ 追加 */
      75% { transform: translate(-2px, -2px); } /* ★ 追加 */
      100% { transform: translate(0, 0); } /* ★ 追加 */
    } /* ★ 追加 */

    #errorOverlay { /* ★ 追加 */
      position: fixed; /* ★ 追加 */
      top: 0; /* ★ 追加 */
      left: 0; /* ★ 追加 */
      width: 100%; /* ★ 追加 */
      height: 100%; /* ★ 追加 */
      background: black; /* ★ 追加 */
      color: red; /* ★ 追加 */
      display: flex; /* ★ 追加 */
      justify-content: center; /* ★ 追加 */
      align-items: center; /* ★ 追加 */
      font-size: 48px; /* ★ 追加 */
      font-weight: bold; /* ★ 追加 */
      z-index: 9999; /* ★ 追加 */
      opacity: 0.95; /* ★ 追加 */
    } /* ★ 追加 */
  </style>
</head>
<body>

<h2>月間カウント</h2>

<button id="prevMonth">←</button>
<span id="ym"></span>
<button id="nextMonth">→</button>

<div id="todayLabel" style="margin-top:8px; font-weight:bold;"></div>

<br><br>

<input id="nameInput" placeholder="名前を追加" />
<button id="addNameBtn">追加</button>

<br><br>

<table id="calendar"></table>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import {
    getFirestore,
    collection,
    addDoc,
    doc,
    onSnapshot,
    updateDoc,
    getDoc
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCTri3rZLiory39Om1bjXcdVfTow7dXrfE",
    authDomain: "playcount-805bd.firebaseapp.com",
    projectId: "playcount-805bd",
    storageBucket: "playcount-805bd.firebasestorage.app",
    messagingSenderId: "259970586499",
    appId: "1:259970586499:web:6bd8ea72419279e91308b6",
    measurementId: "G-H1BL5VPHEK"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const now = new Date();
  let currentYear = now.getFullYear();
  let currentMonth = now.getMonth();

  const table = document.getElementById("calendar");
  const ymSpan = document.getElementById("ym");

  function getLocalDateKey(date = new Date()) {
    const y = date.getFullYear();
    const m = String(date.getMonth() + 1).padStart(2, "0");
    const d = String(date.getDate()).padStart(2, "0");
    return `${y}-${m}-${d}`;
  }

  function getDaysInMonth(y, m) {
    return new Date(y, m + 1, 0).getDate();
  }

  function updateTodayLabel() {
    const today = new Date();
    const y = today.getFullYear();
    const m = today.getMonth() + 1;
    const d = today.getDate();
    document.getElementById("todayLabel").textContent =
      `今日：${y}年${m}月${d}日`;
  }

  function updateYMLabel() {
    ymSpan.textContent = `${currentYear}年 ${currentMonth + 1}月`;
  }

  function renderHeader() {
    const tr = document.createElement("tr");
    tr.innerHTML = `<th>名前</th><th>合計</th>`;
    const days = getDaysInMonth(currentYear, currentMonth);
    for (let d = 1; d <= days; d++) {
      tr.innerHTML += `<th>${d}</th>`;
    }
    table.appendChild(tr);
  }

  function renderName(docSnap) {
    const data = docSnap.data();
    const marks = data.marks || {};
    const tr = document.createElement("tr");
    let count = 0;

    const nameCell = document.createElement("td");
    const btn = document.createElement("button");
    btn.className = "name-btn";
    btn.textContent = data.name;

    btn.onclick = async () => { // ★ 追加
      await triggerAprilFoolsEffect(); // ★ 追加
      toggleMark(docSnap.id); // ★ 追加
    }; // ★ 追加

    nameCell.appendChild(btn);
    tr.appendChild(nameCell);

    const totalCell = document.createElement("td");
    tr.appendChild(totalCell);

    const days = getDaysInMonth(currentYear, currentMonth);
    const todayKey = getLocalDateKey();

    for (let d = 1; d <= days; d++) {
      const dateKey =
        `${currentYear}-${String(currentMonth + 1).padStart(2, "0")}-${String(d).padStart(2, "0")}`;
      const td = document.createElement("td");

      if (marks[dateKey]) {
        td.innerHTML = `<span class="circle">◯</span>`;
        count++;
      }

      if (dateKey === todayKey) {
        td.classList.add("today");
      }

      tr.appendChild(td);
    }

    totalCell.textContent = count;
    table.appendChild(tr);
  }

  async function toggleMark(id) {
    const todayKey = getLocalDateKey();
    const ref = doc(db, "names", id);
    const snap = await getDoc(ref);
    const marks = snap.data().marks || {};

    if (marks[todayKey]) {
      delete marks[todayKey];
    } else {
      marks[todayKey] = true;
    }
    await updateDoc(ref, { marks });
  }

  function rerender() {
    table.innerHTML = "";
    updateYMLabel();
    updateTodayLabel();
    renderHeader();
    snapshotCache.forEach(renderName);
  }

  let snapshotCache = [];

  onSnapshot(collection(db, "names"), snap => {
    snapshotCache = [];
    snap.forEach(d => snapshotCache.push(d));
    rerender();
  });

  document.getElementById("addNameBtn").onclick = async () => {
    const name = document.getElementById("nameInput").value.trim();
    if (!name) return;
    await addDoc(collection(db, "names"), { name, marks: {} });
    document.getElementById("nameInput").value = "";
  };

  document.getElementById("prevMonth").onclick = () => {
    currentMonth--;
    if (currentMonth < 0) {
      currentMonth = 11;
      currentYear--;
    }
    rerender();
  };

  document.getElementById("nextMonth").onclick = () => {
    currentMonth++;
    if (currentMonth > 11) {
      currentMonth = 0;
      currentYear++;
    }
    rerender();
  };

  // ★ 追加：エイプリルフール判定
  function isAprilFools() { // ★ 追加
    const now = new Date(); // ★ 追加
    const params = new URLSearchParams(window.location.search);
    const testMode = params.get("test") === "1";
    
    return testMode ||  (now.getMonth() === 3 && now.getDate() === 1); // ★ 追加
  } // ★ 追加

  // ★ 追加：強演出
  function triggerAprilFoolsEffect() { // ★ 追加
    if (!isAprilFools()) return Promise.resolve(); // ★ 追加

    return new Promise(resolve => { // ★ 追加

      document.body.classList.add("glitch"); // ★ 追加

      const overlay = document.createElement("div"); // ★ 追加
      overlay.id = "errorOverlay"; // ★ 追加
      overlay.textContent = "DATA CORRUPTED"; // ★ 追加
      document.body.appendChild(overlay); // ★ 追加

      document.querySelectorAll(".circle").forEach(el => { // ★ 追加
        el.style.visibility = "hidden"; // ★ 追加
      }); // ★ 追加

      document.querySelectorAll("tr").forEach(tr => { // ★ 追加
        const totalCell = tr.children[1]; // ★ 追加
        if (totalCell && totalCell.tagName === "TD") { // ★ 追加
          totalCell.textContent = "9999"; // ★ 追加
        } // ★ 追加
      }); // ★ 追加

      setTimeout(() => { // ★ 追加
        document.body.classList.remove("glitch"); // ★ 追加
        overlay.remove(); // ★ 追加

        setTimeout(() => {
          reslve();
        }, 2000);
        
        resolve(); // ★ 追加
      }, 2000); // ★ 追加

    }); // ★ 追加
  } // ★ 追加

  
</script>

</body>
</html>



